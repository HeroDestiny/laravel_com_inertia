name: SonarQube Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

env:
  WORKING_DIR: ./src
  PHP_VERSION: '8.3'
  NODE_VERSION: '22'

jobs:
  sonarqube:
    name: SonarQube Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for SonarQube

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          coverage: xdebug
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
          ini-values: memory_limit=512M

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ${{ env.WORKING_DIR }}/vendor
          key: composer-sonar-${{ runner.os }}-php${{ env.PHP_VERSION }}-${{ hashFiles('src/composer.lock') }}
          restore-keys: |
            composer-sonar-${{ runner.os }}-php${{ env.PHP_VERSION }}-

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-scripts
          npm ci --prefer-offline --no-audit

      - name: Setup Laravel
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          cp .env.testing .env
          php artisan key:generate --ansi
          php artisan config:cache
          php artisan ziggy:generate

      - name: Generate test coverage
        working-directory: ${{ env.WORKING_DIR }}
        env:
          XDEBUG_MODE: coverage
        run: |
          echo "üß™ Running PHPUnit with coverage..."
          
          # Ensure coverage directory exists and is clean for PHP files
          mkdir -p coverage
          
          # Run PHPUnit with detailed output
          echo "üìã PHPUnit command:"
          echo "vendor/bin/phpunit --configuration phpunit.xml --coverage-clover=coverage/clover.xml --coverage-xml=coverage/coverage-xml --log-junit=coverage/junit.xml --stop-on-failure"
          
          # Run the actual command and capture exit code
          if vendor/bin/phpunit \
            --configuration phpunit.xml \
            --coverage-clover=coverage/clover.xml \
            --coverage-xml=coverage/coverage-xml \
            --log-junit=coverage/junit.xml \
            --verbose; then
            echo "‚úÖ PHPUnit completed successfully"
          else
            echo "‚ùå PHPUnit failed with exit code $?"
            echo "ÔøΩ Checking what files were created anyway:"
            ls -la coverage/ || echo "No coverage directory"
            exit 1
          fi
          
          echo "üìÅ Files created by PHPUnit:"
          ls -la coverage/

      - name: Generate frontend coverage
        working-directory: ${{ env.WORKING_DIR }}
        continue-on-error: true
        run: |
          if [ -f "vitest.config.ts" ]; then
            npx vitest run --coverage --reporter=verbose || true
          fi

      - name: Verify files for analysis
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üìÅ Checking PHP files in app/:"
          find app -name "*.php" -type f | head -5
          echo ""
          echo "üìÅ Checking JS/Vue files:"
          find resources/js -name "*.js" -o -name "*.vue" -o -name "*.ts" -type f | head -5
          echo ""
          echo "üìÅ Coverage files status:"
          if [ -d "coverage" ]; then
            echo "‚úÖ Coverage directory exists"
            ls -la coverage/
            echo ""
            echo "üìÑ Clover XML content check:"
            if [ -f "coverage/clover.xml" ]; then
              echo "‚úÖ clover.xml exists ($(wc -l < coverage/clover.xml) lines)"
              head -3 coverage/clover.xml
            else
              echo "‚ùå clover.xml missing"
            fi
            echo ""
            echo "üìÑ JUnit XML content check:"
            if [ -f "coverage/junit.xml" ]; then
              echo "‚úÖ junit.xml exists ($(wc -l < coverage/junit.xml) lines)"
            else
              echo "‚ùå junit.xml missing"
            fi
          else
            echo "‚ùå Coverage directory missing"
          fi

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_SCANNER_OPTS: "-Dsonar.verbose=true"
        with:
          projectBaseDir: ${{ env.WORKING_DIR }}

      - name: SonarQube Quality Gate Check
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: ${{ env.WORKING_DIR }}/.scannerwork/report-task.txt
